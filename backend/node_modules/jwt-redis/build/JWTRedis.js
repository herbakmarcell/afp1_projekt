"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const jsonwebtoken = require("jsonwebtoken");
const Redis_1 = require("./Redis");
const TokenInvalidError_1 = require("./error/TokenInvalidError");
const TokenDestroyedError_1 = require("./error/TokenDestroyedError");
class JWTRedis {
    constructor(redisClient, options) {
        this.redisClient = redisClient;
        this.sign = async (payload, secretOrPrivateKey, options) => {
            const jti = payload.jti || generateId(10);
            const token = jsonwebtoken.sign(Object.assign(Object.assign({}, payload), { jti }), secretOrPrivateKey, options);
            const decoded = jsonwebtoken.decode(token);
            const key = this.options.prefix + jti;
            if (decoded.exp) {
                const now = Date.now();
                const duration = Math.floor(decoded.exp - (now / 1000));
                if (duration > 0) {
                    await this.redis.setExp(key, 'true', duration);
                }
            }
            else {
                await this.redis.set(key, 'true');
            }
            return token;
        };
        this.destroy = (jti) => {
            const key = this.options.prefix + jti;
            return this.redis.del(key);
        };
        this.options = Object.assign({ prefix: 'jwt_label:' }, options || {});
        this.redis = new Redis_1.default(redisClient);
    }
    decode(token, options) {
        return jsonwebtoken.decode(token, options);
    }
    verify(token, secretOrPublicKey, options) {
        return new Promise((resolve, reject) => {
            return jsonwebtoken.verify(token, secretOrPublicKey, options, (err, decoded) => {
                if (err) {
                    return reject(err);
                }
                return resolve(decoded);
            });
        }).then((decoded) => {
            if (!decoded.jti) {
                throw new TokenInvalidError_1.default();
            }
            const key = this.options.prefix + decoded.jti;
            return this.redis.get(key)
                .then((result) => {
                if (!result) {
                    throw new TokenDestroyedError_1.default();
                }
                return decoded;
            });
        });
    }
}
exports.default = JWTRedis;
function generateId(length) {
    let result = '';
    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    const charactersLength = characters.length;
    for (var i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * charactersLength));
    }
    return result;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSldUUmVkaXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvSldUUmVkaXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2Q0FBNkM7QUFHN0MsbUNBQTRCO0FBSTVCLGlFQUEwRDtBQUMxRCxxRUFBOEQ7QUFROUQsTUFBcUIsUUFBUTtJQUt6QixZQUE2QixXQUE0QixFQUFFLE9BQWlCO1FBQS9DLGdCQUFXLEdBQVgsV0FBVyxDQUFpQjtRQUtsRCxTQUFJLEdBQUcsS0FBSyxFQUF3QyxPQUFVLEVBQUUsa0JBQTBCLEVBQUUsT0FBcUIsRUFBbUIsRUFBRTtZQUN6SSxNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsR0FBRyxJQUFJLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUMxQyxNQUFNLEtBQUssR0FBVyxZQUFZLENBQUMsSUFBSSxpQ0FBSyxPQUFPLEtBQUUsR0FBRyxLQUFHLGtCQUFrQixFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQ3hGLE1BQU0sT0FBTyxHQUFRLFlBQVksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDaEQsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEdBQUcsR0FBRyxDQUFDO1lBQ3RDLElBQUksT0FBTyxDQUFDLEdBQUcsRUFBRTtnQkFDYixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7Z0JBQ3ZCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsR0FBRyxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUN4RCxJQUFHLFFBQVEsR0FBRyxDQUFDLEVBQUM7b0JBQ1osTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsTUFBTSxFQUFHLFFBQVEsQ0FBQyxDQUFDO2lCQUNuRDthQUNKO2lCQUFLO2dCQUNGLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FB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